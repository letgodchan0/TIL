# [운영체제] - 동기화 기법

프로세스를 동기화 하지 않으면, 아무 문제 없어 보이는 코드도 예기치 못하게 동작할 수 있다. 동기화 대표 도구인 뮤테스 락, 세마포, 모니터에 대해 알아보자!

<HR>

<BR>

### - 뮤텍스 락

```TEXT
동시에 접근해서는 안되는 자원에 동시에 접근하지 않도록 만드는 도구, 상호 배제를 위한 동기화 도구
```

임계 구역에 진입하는 프로세스는 '내가 임계 구역에 있어!'라고 알리기 위해 `뮤텍스 락`을 이용해 임계 구역에 자물쇠를 걸어두고, 다른 프로세스는 임계 구역이 잠겨 있다면 기다리고, 잠기지 않았다면 임계 구역에 진입할 수 있다. 

매우 단순한 형태로 뮤텍스 락을 구현하면, 하나의 전역 변수와 두 개의 함수로 구현 할 수 있다.

자물쇠 역할 : 프로세스들이 공유하는 전역 변수 LOCK

임계 구역을 잠구는 역할 : acquire 함수

임계 구역의 잠금을 해제하는 역할 : release 함수

```text
acquire(){	// 함수 실행
	while (lock == true) // 임계 구역이 잠겨 있다면
					// 임계 구역이 잠겨 있는지 반복적으로 확인
	lock = true;	// 임계 구역이 잠겨 있지 않다면 임계 구역 잠금
} 
// 임계 구역
release(){ // 함수 실행
	lock = false;	// 임계 구역 작업이 끝났으니 잠금 해제
}
```

1. 프로세스는 락을 획득할 수 없다면 (임계 구역 진입 불가라면) 무작정 기다린다.
2. 락을 획득할 수 있다면 (임계 구역 진입 가능) 임계 구역을 잠근 뒤 임계 구역에서 작업 진행
3. 임계 구역에서 빠져나올 때 다시 임계 구역 잠금 해제

<br>

### - 세마포

```text
뮤텍스 락이 하나의 임계 구역을 상정한다면, 세마포는 여러 개의 공유 자원 상황에서도 적용 가능한 동기화 도구
```

- 임계 구역에 진입할 수 있는 프로세스의 개수(사용 가능한 공유 자원의 개수)를 나타내는 전역 변수 S
- 임계 구역에 들어가도 좋은지, 기다려야 할지를 알려주는 wait 함수
- 임계 구역 앞에서 기다리는 프로세스에 '이제 들어가도 좋다'고 신호를 주는 signal 함수

```text
wati()
// 임계 구역
signal()
```

예를 들어, 공유 자원 2개(S = 2), 접근하려는 프로세스는 3개 일 때, P1, P2, P3 순서로 임계 구역에 접근한다면!

![image-20221205122508201](%5B%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C%5D%20-%20%EB%8F%99%EA%B8%B0%ED%99%94%20%EA%B8%B0%EB%B2%95.assets/image-20221205122508201.png)

1. P1 프로세스 wait 호출, S를 1로 감소시킴 (S=1), 임계 구역 진입
2. P2 프로세스 wait 호출, S를 1로 감소시킴 (S=0), 임계 구역 진입
3. P3 프로세스 wait 호출, S를 1로 감소시킴 (S=-1), 본인의 PCB를 대기 큐에 넣고 대기 상태로 전환
4. 프로세스 P1 임계 구역 작업 종료, signal 호출, S를 1로 증가 (S=0), 대기 상태였던 P3를 대기 큐에서 꺼내 준비 큐로 옮김
5. 준비된 프로세스 P3 임계 구역 진입
6. 프로세스 P2 임계 구역 작업 종료 signal 호출, S를 1로 증가 (S=1)
7. 프로세스 P3 임계 구역 작업 종료 signal 호출, S를 1로 증가 (S=2)

뮤텍스 락 처럼 wait이 계속해서 변수 S를 확인하는 것은 CPU 주기를 낭비하기 때문에 손해다. 따라서 사용 가능 자원이 없다면 위와 같이 해당 프로세스를 대기 상태로 만들고, 대기 큐에 넣은 후 자원 사용이 가능할 때 준비 상태로 변경하고 준비큐로 옮겨주는 것이 더 생산성 있는 작업이다!!!

<BR>

### - 모니터

```TEXT
- 공유 자원과 공유 자원에 접근하기 위한 인터페이스(통로)를 둔다. 
- 프로세스는 반드시 인터페이스를 통해서만 공유 자원 접근 가능
```

![image-20221205123948140](%5B%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C%5D%20-%20%EB%8F%99%EA%B8%B0%ED%99%94%20%EA%B8%B0%EB%B2%95.assets/image-20221205123948140.png)

모니터를 통해 공유 자원에 접근하고자 하는 프로세스를 큐에 삽입하고, 큐에 삽입된 순서대로 하나씩 공유 자원을 이용하도록 한다. 모니터는 공유 자원을 다루는 인터페이스에 접근하기 위한 큐 (모니터에 진입하기 위한 큐)를 만들고, 모니터 안에 항상 하나의 프로세스만 들어오도록 하여 상호 배제를 위한 동기화를 제공한다.

모니터는 실행 순서 제어를 위한 동기화를 위해 `조건 변수`를 사용한다.

`조건 변수` : 프로세스나 스레드의 실행 순서를 제어하기 위해 사용하는 특별 변수로 wait과 signal 연산을 수행할 수 있다.

모니터 안에 들어온 프로세스가 조건 변수 x 에 대한 wait을 호출했을 때 (`x.wait()`) 그 프로세스는 조건 변수 x에 대한 큐에 삽입되고, 모니터는 비워지게 된다. 따라서 다른 프로세스가 모니터 안에 들어올 수 있다.

wait 연산으로 일시 중지된 프로세스는 새로 들어온 프로세스의 signal 연산을 호출하고 모니터를 떠난 뒤 재개될 수 있다. (모니터 내에서는 하나의 프로세스만 있을 수 있기 때문!)

> 모니터는 조건 변수를 이용하여 아래와 같은 프로세스 실행 순서 제어를 위한 동기화를 제공한다.

1. 특정 프로세스가 아직 실행될 조건이 되지 않았다면 wait를 통해 실행을 중단한다.
2. 특정 프로세스가 실행될 조건이 충족되었다면, singal을 통해 실행을 재개한다. 